---
title: "OVCCoordenadas Web Service"
author:
  - Ángel Delgado Panadero
  - Diego Hernangómez
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{OVCCoordenadas Web Service}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

<!-- ovcservice.Rmd is generated from ovcservice.Rmd.orig. Please edit that file -->



**CatastRo** allows to query the OVCCoordenadas Web Service provided on [Sede
electrónica del
Catastro](https://ovc.catastro.meh.es/ovcservweb/ovcswlocalizacionrc/ovccoordenadas.asmx)
API directly through a R IDE.

This API is used to retrieve the spatial coordinates of a urban property,
moreover it is not needed to be the owner to get the information, actually it is
enough to know the cadastral reference (RC) of the property and its address (in
fact, it is only completely compulsory to know the RC, however, to ensure a good
result from the response and to avoid mistakes in the RC, the address can be
passed to the query too).

Secondly, the API can be used to obtain a RC of a urban property, for this
information, the API asks for the longitude and the latitude. Furthermore, it
allows to choose the spacial reference system (SRS, also known as CRS) between a
list of them to express the coordinates.

Finally, the API tackles the issue of not knowing the exact point which the
urban property has been registered. In this case, it will return all the
properties located in a square 50-meters-side around the given point.

The documentation of this API can be found
[here](https://ovc.catastro.meh.es/ovcservweb/ovcswlocalizacionrc/ovccoordenadas.asmx).

These functions are named `catr_ovc_*` and returns a tibble, as provided
by the package **tibble**.


## CatastRo API

The OVCCoordenadas Web Service can be reached using the following
functions:

* `catr_ovc_get_rccoor()`
* `catr_ovc_get_rccoor_distancia()`
* `catr_ovc_get_cpmrc()`

## Reverse Geocoding Cadastral References

The function `catr_ovc_get_rccoor()` receives the coordinates (*lat* and *lon*) and
the spatial reference system (SRS) used to express them. The return is a tibble
with the cadastral reference of the property in that spatial point, including
also other information as the address (town street and number).


```r
result <- catr_ovc_get_rccoor(
  lat = 38.6196566583596,
  lon = -3.45624183836806,
  srs = "4230"
)
#> Error in `httr2::req_perform()` at project/R/ovc_rccoor.R:85:3:
#> ! Failed to perform HTTP request.
#> Caused by error in `curl::curl_fetch_memory()`:
#> ! Recv failure: Connection reset by peer
```


```
#> Error in eval(expr, envir, enclos): object 'result' not found
```

The function accept as a SRS argument the following values:


```r
data(catr_srs_values)

# OVC valid codes
library(dplyr)

catr_srs_values %>%
  filter(ovc_service == TRUE) %>%
  select(SRS, Description) %>%
  knitr::kable()
```



|   SRS|Description            |
|-----:|:----------------------|
|  4230|Geográficas en ED 50   |
|  4258|Geográficas en ETRS89  |
|  4326|Geográficas en WGS 80  |
| 23029|UTM huso 29N en ED50   |
| 23030|UTM huso 30N en ED50   |
| 23031|UTM huso 31N en ED50   |
| 25829|UTM huso 29N en ETRS89 |
| 25830|UTM huso 30N en ETRS89 |
| 25831|UTM huso 31N en ETRS89 |
| 32627|UTM huso 27N en WGS 84 |
| 32628|UTM huso 28N en WGS 84 |
| 32629|UTM huso 29N en WGS 84 |
| 32630|UTM huso 30N en WGS 84 |
| 32631|UTM huso 31N en WGS 84 |



It is also possible to get all the cadastral references in a square of
50-meters' side centered in the coordinates *lat* and *lon* through the function
`catr_ovc_get_rccoor_distancia()`.


```r
catr_ovc_get_rccoor_distancia(
  lat = 40.96002,
  lon = -5.663408,
  srs = "4230"
) %>%
  knitr::kable()
#> Error in `httr2::req_perform()` at project/R/ovc_rccoor_distancia.R:97:3:
#> ! Failed to perform HTTP request.
#> Caused by error in `curl::curl_fetch_memory()`:
#> ! Recv failure: Connection reset by peer
```

## Geocoding a Cadastral Reference

The opposite query is possible as well. Being given to the function
`catr_ovc_get_cpmrc()` a cadastral reference (`rc`), the province (`province`) and
the town (`municipality`), `catr_ovc_get_cpmrc()` returns its coordinates *lat* and
*lon* in a particular *SRS* besides the address (town, street and number).


```r
catr_ovc_get_cpmrc(
  rc = "13077A01800039",
  srs = "4230",
  province = "CIUDAD REAL",
  municipality = "SANTA CRUZ DE MUDELA"
) %>%
  knitr::kable()
#> Error in `httr2::req_perform()` at project/R/ovc_cpmrc.R:104:3:
#> ! Failed to perform HTTP request.
#> Caused by error in `curl::curl_fetch_memory()`:
#> ! Recv failure: Connection reset by peer
```

Neither the `province` nor `municipality` are required to be passed to the
function, unless the argument `municipality` is not `NULL`, in that case the
argument `province` is needed to be passed. If it is passed a value to the
`province` argument while the `municipality` argument is `NULL`, the function
`catr_ovc_get_cpmrc()` will throw a message and would return a tibble with no data.


```r
catr_ovc_get_cpmrc(
  rc = "13077A01800039",
  municipality = "SANTA CRUZ DE MUDELA"
) %>%
  knitr::kable()
#> Error in `httr2::req_perform()` at project/R/ovc_cpmrc.R:104:3:
#> ! Failed to perform HTTP request.
#> Caused by error in `curl::curl_fetch_memory()`:
#> ! Recv failure: Connection reset by peer
```

When using only `rc` the result is provided as expected:


```r
# No warning, get the result
catr_ovc_get_cpmrc(rc = "13077A01800039") %>%
  knitr::kable()
#> Error in `httr2::req_perform()` at project/R/ovc_cpmrc.R:104:3:
#> ! Failed to perform HTTP request.
#> Caused by error in `curl::curl_fetch_memory()`:
#> ! Recv failure: Connection reset by peer
```
